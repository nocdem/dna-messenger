# DNA Messenger CI/CD Pipeline
# Builds Flutter app for Linux, Windows, Android, macOS
# Uses instrumentisto/flutter for Android/Linux/Web builds

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always
    - when: never

stages:
  - build-native
  - build-flutter

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  CMAKE_BUILD_TYPE: Release
  DEBIAN_FRONTEND: noninteractive
  FLUTTER_VERSION: "3.27"

# =============================================================================
# STAGE 1: Build Native Libraries (dna_lib)
# =============================================================================

# Build native library for Linux x64
build:native-linux-x64:
  stage: build-native
  tags:
    - linux
  image: ubuntu:24.04
  cache:
    key: opendht-linux-x64-v2
    paths:
      - .cache/opendht/
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq build-essential cmake git pkg-config xxd wget tar
    # Core dependencies
    - apt-get install -y -qq libssl-dev libcurl4-openssl-dev libjson-c-dev libsqlite3-dev libzstd-dev
    # OpenDHT build dependencies
    - apt-get install -y -qq libgnutls28-dev libargon2-dev libmsgpack-dev libreadline-dev libncurses5-dev nettle-dev libjsoncpp-dev libfmt-dev libasio-dev libhttp-parser-dev libcppunit-dev
    # Flutter Linux desktop dependencies
    - apt-get install -y -qq libgtk-3-dev libblkid-dev liblzma-dev
    # Build OpenDHT from source
    - |
      export HOME="${CI_PROJECT_DIR}"
      if [ ! -f ".cache/opendht/lib/libopendht.a" ]; then
        mkdir -p .cache/opendht-src && cd .cache/opendht-src
        git clone --depth 1 --branch v3.2.0 https://github.com/savoirfairelinux/opendht.git || true
        cd opendht && mkdir -p build && cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/.cache/opendht \
                 -DCMAKE_BUILD_TYPE=Release \
                 -DOPENDHT_PYTHON=OFF \
                 -DOPENDHT_TOOLS=OFF \
                 -DBUILD_SHARED_LIBS=OFF
        make -j$(nproc) && make install
        cd "${CI_PROJECT_DIR}"
      fi
    - export PKG_CONFIG_PATH="${CI_PROJECT_DIR}/.cache/opendht/lib/pkgconfig:$PKG_CONFIG_PATH"
    - export CMAKE_PREFIX_PATH="${CI_PROJECT_DIR}/.cache/opendht:$CMAKE_PREFIX_PATH"
  script:
    - mkdir -p build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=OFF -DBUILD_SHARED_LIBS=ON -DBUILD_DNA_NODUS=OFF
    - make -j$(nproc) dna_lib
    - mkdir -p ${CI_PROJECT_DIR}/native-libs/linux-x64
    - cp libdna_lib.so ${CI_PROJECT_DIR}/native-libs/linux-x64/
  artifacts:
    paths:
      - native-libs/linux-x64/
    expire_in: 1 day

# Build native library for Android (arm64-v8a)
build:native-android-arm64:
  stage: build-native
  tags:
    - linux
  image: ubuntu:22.04
  variables:
    ANDROID_NDK_VERSION: "26b"
    ANDROID_API_LEVEL: "24"
  cache:
    key: android-ndk-v2
    paths:
      - .cache/android-ndk/
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq build-essential cmake git pkg-config xxd wget unzip
    # Download Android NDK
    - |
      export HOME="${CI_PROJECT_DIR}"
      if [ ! -d ".cache/android-ndk/android-ndk-r${ANDROID_NDK_VERSION}" ]; then
        mkdir -p .cache/android-ndk && cd .cache/android-ndk
        wget -q https://dl.google.com/android/repository/android-ndk-r${ANDROID_NDK_VERSION}-linux.zip
        unzip -q android-ndk-r${ANDROID_NDK_VERSION}-linux.zip
        rm android-ndk-r${ANDROID_NDK_VERSION}-linux.zip
        cd "${CI_PROJECT_DIR}"
      fi
    - export ANDROID_NDK_HOME="${CI_PROJECT_DIR}/.cache/android-ndk/android-ndk-r${ANDROID_NDK_VERSION}"
    - export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
  script:
    - mkdir -p build-android && cd build-android
    - |
      cmake .. \
        -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake \
        -DANDROID_ABI=arm64-v8a \
        -DANDROID_PLATFORM=android-${ANDROID_API_LEVEL} \
        -DCMAKE_BUILD_TYPE=Release \
        -DBUILD_IMGUI_GUI=OFF \
        -DBUILD_SHARED_LIBS=ON \
        -DBUILD_ANDROID=ON
    - make -j$(nproc) dna_lib
    - mkdir -p ${CI_PROJECT_DIR}/native-libs/android-arm64
    - cp libdna_lib.so ${CI_PROJECT_DIR}/native-libs/android-arm64/
  artifacts:
    paths:
      - native-libs/android-arm64/
    expire_in: 1 day
  allow_failure: true  # Android NDK build may need additional config

# Build native library for Windows x64 (cross-compile with MinGW)
build:native-windows-x64:
  stage: build-native
  tags:
    - linux
  image: ubuntu:22.04
  timeout: 2h
  cache:
    key: llvm-mingw-v2
    paths:
      - .cache/llvm-mingw/
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq build-essential cmake git pkg-config xxd wget tar xz-utils zip unzip
    # Download llvm-mingw toolchain
    - |
      export HOME="${CI_PROJECT_DIR}"
      if [ ! -d ".cache/llvm-mingw/llvm-mingw-20241030-ucrt-ubuntu-20.04-x86_64" ]; then
        mkdir -p .cache/llvm-mingw && cd .cache/llvm-mingw
        wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/20241030/llvm-mingw-20241030-ucrt-ubuntu-20.04-x86_64.tar.xz
        tar xf llvm-mingw-20241030-ucrt-ubuntu-20.04-x86_64.tar.xz
        rm llvm-mingw-20241030-ucrt-ubuntu-20.04-x86_64.tar.xz
        cd "${CI_PROJECT_DIR}"
      fi
    - export MINGW_ROOT="${CI_PROJECT_DIR}/.cache/llvm-mingw/llvm-mingw-20241030-ucrt-ubuntu-20.04-x86_64"
    - export PATH="${MINGW_ROOT}/bin:$PATH"
  script:
    - chmod +x build-cross-compile.sh setup-windows-build.sh
    - ./build-cross-compile.sh windows-x64
    - mkdir -p native-libs/windows-x64
    - cp dist/windows-x64/*.dll native-libs/windows-x64/ || cp build-windows-x64/dna_lib.dll native-libs/windows-x64/ || true
  artifacts:
    paths:
      - native-libs/windows-x64/
      - dist/windows-x64/
    expire_in: 1 day
  allow_failure: true

# =============================================================================
# STAGE 2: Build Flutter Apps
# =============================================================================

# Flutter Linux build
build:flutter-linux:
  stage: build-flutter
  tags:
    - linux
  image: instrumentisto/flutter:${FLUTTER_VERSION}
  needs:
    - build:native-linux-x64
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libgtk-3-dev libblkid-dev liblzma-dev clang cmake ninja-build pkg-config
  script:
    - cd dna_messenger_flutter
    # Copy native library
    - mkdir -p linux/libs
    - cp ${CI_PROJECT_DIR}/native-libs/linux-x64/libdna_lib.so linux/libs/
    # Build Flutter Linux app
    - flutter pub get
    - flutter build linux --release
    # Package
    - mkdir -p ${CI_PROJECT_DIR}/dist/flutter-linux
    - cp -r build/linux/x64/release/bundle/* ${CI_PROJECT_DIR}/dist/flutter-linux/
    - cd ${CI_PROJECT_DIR}/dist && tar -czf dna-messenger-flutter-linux-${CI_COMMIT_SHORT_SHA}.tar.gz flutter-linux/
  artifacts:
    name: "dna-messenger-flutter-linux-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/*.tar.gz
      - dist/flutter-linux/
    expire_in: 1 week

# Flutter Android build
build:flutter-android:
  stage: build-flutter
  tags:
    - linux
  image: instrumentisto/flutter:${FLUTTER_VERSION}
  needs:
    - build:native-android-arm64
  script:
    - cd dna_messenger_flutter
    # Copy native library to jniLibs
    - mkdir -p android/app/src/main/jniLibs/arm64-v8a
    - cp ${CI_PROJECT_DIR}/native-libs/android-arm64/libdna_lib.so android/app/src/main/jniLibs/arm64-v8a/
    # Build APK
    - flutter pub get
    - flutter build apk --release
    # Package
    - mkdir -p ${CI_PROJECT_DIR}/dist
    - cp build/app/outputs/flutter-apk/app-release.apk ${CI_PROJECT_DIR}/dist/dna-messenger-android-${CI_COMMIT_SHORT_SHA}.apk
  artifacts:
    name: "dna-messenger-android-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/*.apk
    expire_in: 1 week
  allow_failure: true  # Depends on Android native build

# Flutter Windows build (requires Windows runner or cross-compilation)
build:flutter-windows:
  stage: build-flutter
  tags:
    - windows
  needs:
    - build:native-windows-x64
  before_script:
    - choco install flutter --version=3.27.0 -y || true
    - refreshenv
  script:
    - cd dna_messenger_flutter
    # Copy native library
    - mkdir -p windows/libs
    - copy ${CI_PROJECT_DIR}/native-libs/windows-x64/*.dll windows/libs/
    # Build Flutter Windows app
    - flutter pub get
    - flutter build windows --release
    # Package
    - mkdir -p ${CI_PROJECT_DIR}/dist/flutter-windows
    - xcopy /E /I build\windows\x64\runner\Release ${CI_PROJECT_DIR}/dist/flutter-windows
  artifacts:
    name: "dna-messenger-flutter-windows-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/flutter-windows/
    expire_in: 1 week
  allow_failure: true  # Requires Windows runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual  # Manual trigger for Windows builds

# Flutter macOS build (requires macOS runner)
build:flutter-macos:
  stage: build-flutter
  tags:
    - macos
  before_script:
    # Ensure Flutter is installed via Homebrew or direct download
    - brew install flutter || true
    - flutter doctor
  script:
    - cd dna_messenger_flutter
    # Build native library for macOS first
    - cd ${CI_PROJECT_DIR}
    - mkdir -p build-macos && cd build-macos
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_IMGUI_GUI=OFF -DBUILD_SHARED_LIBS=ON
    - make -j$(sysctl -n hw.ncpu) dna_lib
    # Copy to Flutter
    - cd ${CI_PROJECT_DIR}/dna_messenger_flutter
    - mkdir -p macos/Frameworks
    - cp ${CI_PROJECT_DIR}/build-macos/libdna_lib.dylib macos/Frameworks/
    # Build Flutter macOS app
    - flutter pub get
    - flutter build macos --release
    # Package
    - mkdir -p ${CI_PROJECT_DIR}/dist
    - cd build/macos/Build/Products/Release
    - zip -r ${CI_PROJECT_DIR}/dist/dna-messenger-macos-${CI_COMMIT_SHORT_SHA}.zip "DNA Messenger.app"
  artifacts:
    name: "dna-messenger-macos-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/*.zip
    expire_in: 1 week
  allow_failure: true  # Requires macOS runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual  # Manual trigger for macOS builds
