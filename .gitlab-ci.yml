# DNA Messenger CI/CD Pipeline
# Builds for Linux and Windows with static linking where possible

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always
    - when: never

stages:
  - build

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  CMAKE_BUILD_TYPE: Release

# Linux x86_64 build
build:linux-x64:
  stage: build
  tags:
    - linux
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq build-essential cmake git pkg-config xxd
    # ImGui GUI dependencies
    - apt-get install -y -qq libgl1-mesa-dev libglfw3-dev libglew-dev libfreetype6-dev
    # OpenDHT dependencies
    - apt-get install -y -qq libgnutls28-dev libargon2-dev libmsgpack-dev libreadline-dev libncurses5-dev nettle-dev libjsoncpp-dev
    # Crypto and network dependencies
    - apt-get install -y -qq libssl-dev libcurl4-openssl-dev
  script:
    - mkdir -p build
    - cd build
    # Static link libgcc and libstdc++ to reduce dependencies
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++"
    - make -j$(nproc)
    - ls -lh imgui_gui/
    # Show what dependencies are needed
    - echo "=== Binary dependencies ==="
    - ldd imgui_gui/dna_messenger_imgui || true
  artifacts:
    name: "dna-messenger-linux-x64-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/imgui_gui/dna_messenger_imgui
    expire_in: 2 days  # Short expiry to avoid spam, latest successful build is kept

# Windows x86_64 build (MinGW cross-compile)
build:windows-x64:
  stage: build
  tags:
    - linux
  image: ubuntu:22.04
  timeout: 30m
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq build-essential cmake git pkg-config xxd
    - apt-get install -y -qq mingw-w64 g++-mingw-w64-x86-64 gcc-mingw-w64-x86-64
  script:
    # Use the existing cross-compile script
    - chmod +x build-cross-compile.sh
    - ./build-cross-compile.sh windows-x64
  artifacts:
    name: "dna-messenger-windows-x64-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/*.zip
      - dist/*.tar.gz
      - dist/windows-x64/
    expire_in: 2 days  # Short expiry to avoid spam, latest successful build is kept
  allow_failure: true