# Security Audit Plan - DNA Messenger
## Data Storage & Application-Level Security

### Audit Scope
Comprehensive security exploration of:
1. SQLite Database Security
2. File System Security
3. User Input Handling
4. Authentication & Authorization
5. Logging & Error Handling
6. Dependencies & CVEs

### Phase 1: Directory Structure Analysis
- [ ] Map core directories: storage/, db/, imgui_gui/, core/
- [ ] Identify data handling components
- [ ] List all CMakeLists.txt files for dependency analysis

### Phase 2: SQLite Database Security (HIGH PRIORITY)
**Search Patterns:**
- `sqlite3_prepare` / `sqlite3_exec` - check for parameterization
- `sqlite3_bind` - verify parameter binding
- `strcpy`, `sprintf`, `strcat` - buffer overflow risks
- SQL string concatenation patterns
- Direct user input to SQL queries

**Files to examine:**
- `/opt/dna-messenger/storage/**/*.{cpp,h,c}`
- `/opt/dna-messenger/core/**/*.{cpp,h,c}` (if exists)
- Database initialization code
- Data access/retrieval code

**Specific Checks:**
- [ ] SQL injection vulnerabilities
- [ ] Unparameterized queries with user input
- [ ] Buffer overflow from user input
- [ ] Database encryption at rest (check for SQLCipher, WAL mode)
- [ ] Sensitive data in plaintext (passwords, keys, auth tokens)
- [ ] Query logging/exposure

### Phase 3: File System Security
**Search Patterns:**
- `fopen`, `open`, `stat`, `access` - file operations
- Path construction: `strcat`, `sprintf`, `/../` patterns
- File permissions: `chmod`, `0644`, `0755`
- Temporary files: `/tmp/`, `tmpnam`, `tempfile`
- Config file paths: `.config`, `.local`, home directory

**Files to examine:**
- `/opt/dna-messenger/imgui_gui/**/*.{cpp,h,c}` - GUI file handling
- `/opt/dna-messenger/core/**/*.{cpp,h,c}` - Config/storage
- Wallet data storage
- User profile/identity storage

**Specific Checks:**
- [ ] Path traversal vulnerabilities
- [ ] Insecure temporary file handling
- [ ] File permission disclosure
- [ ] World-readable sensitive files
- [ ] Home directory path resolution
- [ ] Symlink attacks

### Phase 4: User Input Handling
**Search Patterns:**
- ImGui input functions: `ImGui::InputText`, `ImGui::InputInt`
- String manipulation: `strcpy`, `strncpy`, `sprintf`, `snprintf`
- User messages/identities in UI
- Form validation logic
- Input buffer sizes

**Files to examine:**
- `/opt/dna-messenger/imgui_gui/**/*.{cpp,h,c}` - all GUI input
- `/opt/dna-messenger/core/**/*.{cpp,h,c}` - message handling
- P2P message parsing: `/opt/dna-messenger/p2p/**/*.{cpp,h,c}`

**Specific Checks:**
- [ ] Buffer overflow from ImGui input fields
- [ ] Missing input validation
- [ ] XSS-like issues in UI rendering
- [ ] Command injection risks
- [ ] Format string vulnerabilities
- [ ] Integer overflows in input parsing

### Phase 5: Authentication & Authorization
**Search Patterns:**
- Identity creation/loading
- BIP39 seed/mnemonic handling
- Private key storage/retrieval
- Per-identity contacts
- Access control checks
- Session/identity management

**Files to examine:**
- `/opt/dna-messenger/crypto/bip39/**/*.c`
- `/opt/dna-messenger/core/**/*.{cpp,h,c}` - identity management
- `/opt/dna-messenger/imgui_gui/**/*.{cpp,h,c}` - auth UI

**Specific Checks:**
- [ ] BIP39 seed stored in plaintext
- [ ] Private keys in memory protection
- [ ] Mnemonic phrase exposure
- [ ] Identity switching security
- [ ] Contact authentication
- [ ] Access control enforcement
- [ ] Session handling

### Phase 6: Logging & Error Handling
**Search Patterns:**
- `printf`, `fprintf`, `std::cout` - logging to console
- Error messages: sensitive data exposure
- Debug code: `assert`, `DEBUG`, `TRACE`
- File logging: `/var/log/`, config paths
- Exception handling
- Stack traces

**Files to examine:**
- All `.cpp` and `.h` files for logging patterns
- Error handling throughout codebase
- Bootstrap/DHT logging

**Specific Checks:**
- [ ] Sensitive data in error messages
- [ ] Plaintext logging of keys/credentials
- [ ] Debug code in production paths
- [ ] Information leakage in stack traces
- [ ] Log file permissions
- [ ] Unbounded log growth

### Phase 7: Dependencies & Build Security
**Search Patterns:**
- CMakeLists.txt files
- OpenDHT-PQ version
- Kyber1024 / Dilithium5 versions
- SQLite version
- ImGui version and security patches
- libsodium / OpenSSL versions

**Files to examine:**
- `/opt/dna-messenger/CMakeLists.txt` (root)
- `/opt/dna-messenger/crypto/CMakeLists.txt`
- `/opt/dna-messenger/vendor/opendht-pq/CMakeLists.txt`
- `/opt/dna-messenger/imgui_gui/CMakeLists.txt`
- Dependency version pins

**Specific Checks:**
- [ ] Known CVEs in dependencies
- [ ] Version pinning (reproducible builds)
- [ ] Unsafe library APIs
- [ ] Compiler security flags (-fPIE, -D_FORTIFY_SOURCE)
- [ ] Link-time optimization security

### Phase 8: Special Areas - Group Symmetric Key (GSK)
**Files to examine:**
- `/opt/dna-messenger/core/**/*gsk*`
- GSK encryption/decryption
- Key derivation for group messages
- Session key management

**Checks:**
- [ ] GSK key storage
- [ ] Key rotation security
- [ ] Replay protection
- [ ] Forward secrecy

### Phase 9: Special Areas - Wallet Security
**Files to examine:**
- Cpunk wallet implementation
- BIP39 recovery
- Seed backup/restore
- Transaction signing

**Checks:**
- [ ] Private key protection
- [ ] Seed phrase security
- [ ] Wallet backup encryption
- [ ] Transaction confirmation UI

### Analysis Template

For each finding, document:
```
FILE: /full/path/to/file.cpp
LINE: xxx
SEVERITY: [CRITICAL|HIGH|MEDIUM|LOW]
ISSUE: [Brief description]
DETAILS: [Full context and explanation]
RECOMMENDATION: [Suggested fix]
```

### Output Format
Comprehensive markdown report with:
1. Executive Summary (high-level findings)
2. Critical Issues (security bypass, data leak, auth bypass)
3. High Priority (memory corruption, SQL injection, path traversal)
4. Medium Priority (information disclosure, weak crypto)
5. Low Priority (best practices, hardening)
6. Dependencies Analysis
7. Files Examined (complete list with line counts)
8. Detailed Findings with code snippets
