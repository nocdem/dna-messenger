# DNA Messenger CI/CD Pipeline
# Builds for Linux and Windows using Alpine Linux (minimal image size)
# All dependencies are statically linked for maximum portability

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always
    - when: never

stages:
  - build

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  CMAKE_BUILD_TYPE: Release

# Linux x86_64 build (Alpine with static linking)
build:linux-x64:
  stage: build
  tags:
    - linux
  image: alpine:latest
  before_script:
    # Install build essentials
    - apk add --no-cache build-base cmake git pkgconfig xxd linux-headers
    # ImGui GUI dependencies (static libraries)
    - apk add --no-cache mesa-dev glfw-dev glew-dev freetype-dev freetype-static
    # OpenDHT dependencies (static libraries)
    - apk add --no-cache gnutls-dev gnutls-static argon2-dev argon2-static msgpack-cxx-dev 
    - apk add --no-cache readline-dev readline-static ncurses-dev ncurses-static nettle-dev nettle-static jsoncpp-dev jsoncpp-static
    # Additional static libraries that might be needed
    - apk add --no-cache zlib-dev zlib-static libstdc++-static
  script:
    - mkdir -p build
    - cd build
    # Force static linking
    - cmake .. -DCMAKE_BUILD_TYPE=Release 
        -DCMAKE_EXE_LINKER_FLAGS="-static -static-libgcc -static-libstdc++"
        -DBUILD_SHARED_LIBS=OFF
        -DCMAKE_FIND_LIBRARY_SUFFIXES=".a"
    - make -j$(nproc)
    - ls -lh imgui_gui/
    # Verify it's statically linked
    - ldd imgui_gui/dna_messenger_imgui || echo "Statically linked (no dynamic dependencies)"
    - file imgui_gui/dna_messenger_imgui
  artifacts:
    name: "dna-messenger-linux-x64-static-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/imgui_gui/dna_messenger_imgui
    expire_in: 1 week

# Windows x86_64 build (Alpine with MinGW static linking)
build:windows-x64:
  stage: build
  tags:
    - linux
  image: alpine:latest
  timeout: 30m
  before_script:
    # Install MinGW cross-compiler and build tools
    - apk add --no-cache build-base cmake git pkgconfig xxd
    - apk add --no-cache mingw-w64-gcc
    # Windows builds are always statically linked by default with MinGW
  script:
    # Use the existing cross-compile script which should handle static linking
    - chmod +x build-cross-compile.sh
    - ./build-cross-compile.sh windows-x64
    # Verify static linking
    - file dist/windows-x64/*.exe || true
  artifacts:
    name: "dna-messenger-windows-x64-static-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/*.zip
      - dist/*.tar.gz
    expire_in: 1 week
  allow_failure: true