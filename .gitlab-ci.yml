# DNA Messenger CI/CD Pipeline
# Builds for Linux and Windows with static linking where possible

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always
    - when: never

stages:
  - build

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  CMAKE_BUILD_TYPE: Release

# Linux x86_64 build
build:linux-x64:
  stage: build
  tags:
    - linux
  image: ubuntu:24.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq build-essential cmake git pkg-config xxd
    # Core dependencies
    - apt-get install -y -qq libssl-dev libcurl4-openssl-dev libjson-c-dev libsqlite3-dev
    # P2P/DHT dependencies
    - apt-get install -y -qq libnice-dev libglib2.0-dev
    # OpenDHT dependencies
    - apt-get install -y -qq libopendht-dev libgnutls28-dev libargon2-dev libmsgpack-dev libreadline-dev libncurses5-dev nettle-dev libjsoncpp-dev
    # ImGui GUI dependencies
    - apt-get install -y -qq libgl1-mesa-dev libglfw3-dev libfreetype6-dev
    # Native file dialog (GTK3)
    - apt-get install -y -qq libgtk-3-dev
  script:
    - mkdir -p build
    - cd build
    # Static link libgcc and libstdc++ to reduce dependencies
    - cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++"
    - make -j$(nproc)
    - ls -lh imgui_gui/
    # Show what dependencies are needed
    - echo "=== Binary dependencies ==="
    - ldd imgui_gui/dna_messenger_imgui || true
  artifacts:
    name: "dna-messenger-linux-x64-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build/imgui_gui/dna_messenger_imgui
    expire_in: 1 week

# Windows x86_64 build (MinGW cross-compile)
build:windows-x64:
  stage: build
  tags:
    - linux
  image: ubuntu:20.04
  timeout: 3h
  before_script:
    # Disable interactive prompts
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get update -qq
    # MXE build dependencies
    - apt-get install -y -qq build-essential cmake git pkg-config xxd autoconf automake libtool libtool-bin
    - apt-get install -y -qq bison flex gperf ruby unzip p7zip-full lzip intltool xz-utils
    - apt-get install -y -qq gettext autopoint libssl-dev zlib1g-dev bzip2 libgdk-pixbuf2.0-dev
    - apt-get install -y -qq python3 python3-mako perl libxml-parser-perl
    # Create python symlink for MXE
    - ln -sf /usr/bin/python3 /usr/bin/python || true
    # Set up MXE cache directory
    - export MXE_DIR="${CI_PROJECT_DIR}/.mxe-cache"
    - mkdir -p "${MXE_DIR}"
  cache:
    key: mxe-windows-static-v1
    paths:
      - .mxe-cache/
  script:
    # Use the existing cross-compile script
    - chmod +x build-cross-compile.sh
    - export MXE_DIR="${CI_PROJECT_DIR}/.mxe-cache"
    - ./build-cross-compile.sh windows-x64
  artifacts:
    name: "dna-messenger-windows-x64-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/*.zip
      - dist/*.tar.gz
      - dist/windows-x64/
    expire_in: 1 week
  allow_failure: true